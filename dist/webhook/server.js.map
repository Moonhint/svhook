{"version":3,"sources":["../../app/webhook/server.js"],"names":["Server","constructor","default_settings","app","body_parser","opts","http","execa","cache","shell","server","hook","params","configs","materials","options","route_prefix","print_req_body","use","urlencoded","extended","limit","json","i","length","route","post","material","bash_scripts","req","res","console","log","body","send","webhook_name","ignore_execution","material_branches","only_branches","body_ref","ref","undefined","git_refs_arr","split","source_branch","founded_branch_index","indexOf","curr_bash_script","lookout","last_lookout","get","lookout_script","script","put","lookout_execution_delay","key","value","info","print_and_execute","env","del","toFixed","createServer","listen","port","result","current_directory","process","cwd","startsWith","path","cd","stdout","e","error"],"mappings":"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","file":"server.js","sourcesContent":["export class Server {\n\n  // Depedency Injection:\n  constructor({ default_settings, app, body_parser, opts, http, execa, cache, shell } = {}) {\n    // configuration default_settings\n    this.default_settings = default_settings;\n\n    // express app\n    this.app = app;\n\n    // body parser helper\n    this.body_parser = body_parser;\n\n    // server options\n    this.opts = opts || default_settings.server;\n\n    // http client\n    this.http = http;\n\n    // spawn child process\n    this.execa = execa;\n\n    // memory cache\n    this.cache = cache;\n\n    // shell\n    this.shell = shell;\n  }\n\n  hook(params) {\n    const configs = params || this.default_settings.hook;\n    const materials = configs.materials;\n    const options = configs.options || this.default_settings.hook.options;\n\n    //init all server options fallback variable\n    const route_prefix = this.opts.route_prefix || this.default_settings.server.route_prefix;\n    const print_req_body = this.opts.print_req_body || this.default_settings.server.print_req_body;\n\n    //body parser middleware\n    this.app.use(this.body_parser.urlencoded({ extended: true , limit: '500mb'}));\n    this.app.use(this.body_parser.json({limit: '500mb'}));\n\n    for (var i = 0; i < materials.length; i++) {\n      this.app.route(`/${route_prefix}/${materials[i][\"webhook_url\"]}`).post((\n        () => {\n\n          let material = materials[i];\n          let bash_scripts = material.bash_scripts;\n\n          return async (req, res) => {\n\n            if (print_req_body){\n              console.log(req.body);\n            }\n            \n            res.send(`${material.webhook_name} ok`);\n            \n            let ignore_execution = false;\n\n            let material_branches = material.only_branches;\n            let body_ref = req.body.ref;\n\n            // check for eligible branches if specifed\n            if (material_branches !== undefined && body_ref !== undefined){\n              let git_refs_arr = body_ref.split('/');\n              let source_branch = git_refs_arr[git_refs_arr.length - 1];\n              let founded_branch_index = material_branches.indexOf(source_branch)\n              if (founded_branch_index === -1){\n                // not found in eligible to execute branches, so will ignore execution\n                ignore_execution = true;\n                console.log(`<----- [Ignore Execute] reason: not eligible branch ------>`);\n              }\n            }\n\n            if (!ignore_execution) {\n              for (var i = 0; i < bash_scripts.length; i++) {\n                let curr_bash_script = bash_scripts[i];\n  \n                if (curr_bash_script.lookout){\n                  let last_lookout = this.cache.get(curr_bash_script.lookout);\n                  let lookout_script = curr_bash_script.script;\n  \n                  if (last_lookout === null){\n                    this.cache.put(curr_bash_script.lookout, 1, options.lookout_execution_delay, async (key, value) => {\n                      console.info(`Script of \"${key}\" was stacked ${value} times before execution!`);\n                      this.print_and_execute(lookout_script, options.env);\n                    });\n                  }else{\n                    this.cache.del(curr_bash_script.lookout);\n                    this.cache.put(curr_bash_script.lookout, last_lookout+1, options.lookout_execution_delay, async (key, value) => {\n                      console.info(`Script of \"${key}\" was stacked ${value} times before execution!`);\n                      this.print_and_execute(lookout_script, options.env);\n                    });\n                  }\n                  console.info(`\\nLooking out for another script with key \"${curr_bash_script.lookout}\"`);\n                  console.info(`If none is provided in ${(options.lookout_execution_delay/60000).toFixed(2)} minutes I will execute the script...\\n`);\n                }else{\n                  await this.print_and_execute(curr_bash_script, options.env);\n                }\n              }\n            }\n\n          }\n\n        }\n      )());\n    }\n\n    // add home route\n    this.app.route('/').get((req, res)=>{\n      res.send(`svhook`);\n    });\n\n    //up server\n    let server = this.http.createServer(this.app);\n\n    server.listen(this.opts.port, () => {\n      console.info(`svhook at port ${this.opts.port}`);\n    });\n\n  }\n\n  async print_and_execute(script, env){\n\n    let result;\n    let current_directory = process.cwd();\n\n    if (script.startsWith('cd')){\n      let path = script.split(\" \")[1];\n      console.log(`<----- [Change Directory to ${current_directory}/${path}] ${script} ------>`);\n      this.shell.cd(`${current_directory}/${path}`);\n    }else{\n      try {\n        console.log(`<----- [Execute] ${script} ------>`);\n        result = await this.execa.shell(script, {env});\n        console.log(`<----- [Execution Output] ${script} ------>\\n`);\n        console.log(`${result.stdout}\\n\\n`);\n      } catch (e) {\n        console.error(e);\n      }\n    }\n\n  }\n\n};\n"]}